##  Scale Deployment to Zero

If a Deployment's Pods are seen crashing multiple times it usually indicates there is an issue that must be manually resolved. Removing the failing Pods and marking the Deployment is often a useful troubleshooting step. This policy watches existing Pods and if any are observed to have restarted more than once, indicating a potential crashloop, Kyverno scales its parent deployment to zero and writes an annotation signaling to an SRE team that troubleshooting is needed. It may be necessary to grant additional privileges to the Kyverno ServiceAccount, via one of the existing ClusterRoleBindings or a new one, so it can modify Deployments. This policy scales down deployments with frequently restarting pods by monitoring `Pod.status` for `restartCount`updates, which are performed by the kubelet. No `resourceFilter` modifications are needed if matching on `Pod`and `Pod.status`. Note: For this policy to work, you must modify Kyverno's ConfigMap to remove or change the line `excludeGroups: system:nodes` since version 1.10.

Once the deployments are scaled to 0 and correctly annotated, a Kyverno cleanup policy can be used to cleanup the deployment. The `cleanup-deployments` cleanup policy provided in this folder deletes all the deployments across the cluster that have an annotation of `sre.corp.org/troubleshooting-needed` every minute as per the cron schedule. 

NOTE: Necessary RBAC permissions to update and delete the deployments must be provided prior to deploying the policy.